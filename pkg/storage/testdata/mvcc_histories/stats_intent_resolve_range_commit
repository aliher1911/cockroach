# Tests MVCC stats calculations when resolving intents. Intermediate states are
# tested through stats traces. Initial state:
#
# (x is tombstone, o---o is range tombstone, [] is intent)
#
# 7
# 6 [a6][b6][c6][x] [x] [x] [g6][h6][i6][x] [x] [x] [m6][n6][o6] x   x   x
# 5                                                      n5  x       q5  x
# 4                          o-----------------------------------------------o   
# 3                          o-----------------------------------------------o
# 2 
# 1      b1  x       e1  x       h1  x       k1  x
#    a   b   c   d   e   f   g   h   i   j   k   l   m   n   o   p   q   r   s
#
# This uses two range tombstones, since the lowest is the one that matters for
# point key GCBytesAge. It also uses points below/above range tombstones,
# because iterators surface range keys separately from point keys, which can
# cause bugs if callers don't step onto the point key.
#
# TODO(erikgrinaker): This is probably better handled by randomized or
# generative testing, since the combinations are getting unwieldy. But it'll do
# for now.

run stats
with ts=1
  put k=b v=b1
  del k=c
  put k=e v=e1
  del k=f
  put k=g v=g1
  del k=h
  put k=i v=i1
  del k=j
del_range_ts k=g end=s ts=3
del_range_ts k=g end=s ts=4
with ts=5
  put k=n v=n5
  del k=o
  put k=q v=q5
  del k=r
with t=A
  txn_begin ts=6
  put k=a v=a6
  put k=b v=b6
  put k=c v=c6
  del k=d
  del k=e
  del k=f
  put k=g v=g6
  put k=h v=h6
  put k=i v=i6
  del k=j
  del k=k
  del k=l
  put k=m v=m6
  put k=n v=n6
  put k=o v=o6
  del k=p
  del k=q
  del k=r
----
>> at end:
txn: "A" meta={id=00000000 key=/Min pri=0.00000000 epo=0 ts=6.000000000,0 min=0,0 seq=0} lock=true stat=PENDING rts=6.000000000,0 wto=false gul=0,0
rangekey: {g-s}/[4.000000000,0 3.000000000,0]
meta: "a"/0,0 -> txn={id=00000000 key=/Min pri=0.00000000 epo=0 ts=6.000000000,0 min=0,0 seq=0} ts=6.000000000,0 del=false klen=12 vlen=7 mergeTs=<nil> txnDidNotUpdateMeta=true
data: "a"/6.000000000,0 -> /BYTES/a6
meta: "b"/0,0 -> txn={id=00000000 key=/Min pri=0.00000000 epo=0 ts=6.000000000,0 min=0,0 seq=0} ts=6.000000000,0 del=false klen=12 vlen=7 mergeTs=<nil> txnDidNotUpdateMeta=true
data: "b"/6.000000000,0 -> /BYTES/b6
data: "b"/1.000000000,0 -> /BYTES/b1
meta: "c"/0,0 -> txn={id=00000000 key=/Min pri=0.00000000 epo=0 ts=6.000000000,0 min=0,0 seq=0} ts=6.000000000,0 del=false klen=12 vlen=7 mergeTs=<nil> txnDidNotUpdateMeta=true
data: "c"/6.000000000,0 -> /BYTES/c6
data: "c"/1.000000000,0 -> /<empty>
meta: "d"/0,0 -> txn={id=00000000 key=/Min pri=0.00000000 epo=0 ts=6.000000000,0 min=0,0 seq=0} ts=6.000000000,0 del=true klen=12 vlen=0 mergeTs=<nil> txnDidNotUpdateMeta=true
data: "d"/6.000000000,0 -> /<empty>
meta: "e"/0,0 -> txn={id=00000000 key=/Min pri=0.00000000 epo=0 ts=6.000000000,0 min=0,0 seq=0} ts=6.000000000,0 del=true klen=12 vlen=0 mergeTs=<nil> txnDidNotUpdateMeta=true
data: "e"/6.000000000,0 -> /<empty>
data: "e"/1.000000000,0 -> /BYTES/e1
meta: "f"/0,0 -> txn={id=00000000 key=/Min pri=0.00000000 epo=0 ts=6.000000000,0 min=0,0 seq=0} ts=6.000000000,0 del=true klen=12 vlen=0 mergeTs=<nil> txnDidNotUpdateMeta=true
data: "f"/6.000000000,0 -> /<empty>
data: "f"/1.000000000,0 -> /<empty>
meta: "g"/0,0 -> txn={id=00000000 key=/Min pri=0.00000000 epo=0 ts=6.000000000,0 min=0,0 seq=0} ts=6.000000000,0 del=false klen=12 vlen=7 mergeTs=<nil> txnDidNotUpdateMeta=true
data: "g"/6.000000000,0 -> /BYTES/g6
data: "g"/1.000000000,0 -> /BYTES/g1
meta: "h"/0,0 -> txn={id=00000000 key=/Min pri=0.00000000 epo=0 ts=6.000000000,0 min=0,0 seq=0} ts=6.000000000,0 del=false klen=12 vlen=7 mergeTs=<nil> txnDidNotUpdateMeta=true
data: "h"/6.000000000,0 -> /BYTES/h6
data: "h"/1.000000000,0 -> /<empty>
meta: "i"/0,0 -> txn={id=00000000 key=/Min pri=0.00000000 epo=0 ts=6.000000000,0 min=0,0 seq=0} ts=6.000000000,0 del=false klen=12 vlen=7 mergeTs=<nil> txnDidNotUpdateMeta=true
data: "i"/6.000000000,0 -> /BYTES/i6
data: "i"/1.000000000,0 -> /BYTES/i1
meta: "j"/0,0 -> txn={id=00000000 key=/Min pri=0.00000000 epo=0 ts=6.000000000,0 min=0,0 seq=0} ts=6.000000000,0 del=true klen=12 vlen=0 mergeTs=<nil> txnDidNotUpdateMeta=true
data: "j"/6.000000000,0 -> /<empty>
data: "j"/1.000000000,0 -> /<empty>
meta: "k"/0,0 -> txn={id=00000000 key=/Min pri=0.00000000 epo=0 ts=6.000000000,0 min=0,0 seq=0} ts=6.000000000,0 del=true klen=12 vlen=0 mergeTs=<nil> txnDidNotUpdateMeta=true
data: "k"/6.000000000,0 -> /<empty>
meta: "l"/0,0 -> txn={id=00000000 key=/Min pri=0.00000000 epo=0 ts=6.000000000,0 min=0,0 seq=0} ts=6.000000000,0 del=true klen=12 vlen=0 mergeTs=<nil> txnDidNotUpdateMeta=true
data: "l"/6.000000000,0 -> /<empty>
meta: "m"/0,0 -> txn={id=00000000 key=/Min pri=0.00000000 epo=0 ts=6.000000000,0 min=0,0 seq=0} ts=6.000000000,0 del=false klen=12 vlen=7 mergeTs=<nil> txnDidNotUpdateMeta=true
data: "m"/6.000000000,0 -> /BYTES/m6
meta: "n"/0,0 -> txn={id=00000000 key=/Min pri=0.00000000 epo=0 ts=6.000000000,0 min=0,0 seq=0} ts=6.000000000,0 del=false klen=12 vlen=7 mergeTs=<nil> txnDidNotUpdateMeta=true
data: "n"/6.000000000,0 -> /BYTES/n6
data: "n"/5.000000000,0 -> /BYTES/n5
meta: "o"/0,0 -> txn={id=00000000 key=/Min pri=0.00000000 epo=0 ts=6.000000000,0 min=0,0 seq=0} ts=6.000000000,0 del=false klen=12 vlen=7 mergeTs=<nil> txnDidNotUpdateMeta=true
data: "o"/6.000000000,0 -> /BYTES/o6
data: "o"/5.000000000,0 -> /<empty>
meta: "p"/0,0 -> txn={id=00000000 key=/Min pri=0.00000000 epo=0 ts=6.000000000,0 min=0,0 seq=0} ts=6.000000000,0 del=true klen=12 vlen=0 mergeTs=<nil> txnDidNotUpdateMeta=true
data: "p"/6.000000000,0 -> /<empty>
meta: "q"/0,0 -> txn={id=00000000 key=/Min pri=0.00000000 epo=0 ts=6.000000000,0 min=0,0 seq=0} ts=6.000000000,0 del=true klen=12 vlen=0 mergeTs=<nil> txnDidNotUpdateMeta=true
data: "q"/6.000000000,0 -> /<empty>
data: "q"/5.000000000,0 -> /BYTES/q5
meta: "r"/0,0 -> txn={id=00000000 key=/Min pri=0.00000000 epo=0 ts=6.000000000,0 min=0,0 seq=0} ts=6.000000000,0 del=true klen=12 vlen=0 mergeTs=<nil> txnDidNotUpdateMeta=true
data: "r"/6.000000000,0 -> /<empty>
data: "r"/5.000000000,0 -> /<empty>
stats: {
  contains_estimates:0
  last_update_nanos:1000000000000
  intent_age:17892
  gc_bytes_age:761835
  live_bytes:621
  live_count:9
  key_bytes:396
  key_count:18
  val_bytes:969
  val_count:30
  intent_bytes:279
  intent_count:18
  separated_intent_count:18
  range_key_count:1
  range_key_bytes:22
  sys_bytes:0
  sys_count:0
  abort_span_bytes:0
}

run stats trace
resolve_intent_range t=A k=a end=z status=COMMITTED
----
>> resolve_intent_range t=A k=a end=z status=COMMITTED
called ClearIntent("a", TDNUM(true), 00000000-0000-0000-0000-000000000001)
called ClearIntent("b", TDNUM(true), 00000000-0000-0000-0000-000000000001)
called ClearIntent("c", TDNUM(true), 00000000-0000-0000-0000-000000000001)
called ClearIntent("d", TDNUM(true), 00000000-0000-0000-0000-000000000001)
called ClearIntent("e", TDNUM(true), 00000000-0000-0000-0000-000000000001)
called ClearIntent("f", TDNUM(true), 00000000-0000-0000-0000-000000000001)
called ClearIntent("g", TDNUM(true), 00000000-0000-0000-0000-000000000001)
called ClearIntent("h", TDNUM(true), 00000000-0000-0000-0000-000000000001)
called ClearIntent("i", TDNUM(true), 00000000-0000-0000-0000-000000000001)
called ClearIntent("j", TDNUM(true), 00000000-0000-0000-0000-000000000001)
called ClearIntent("k", TDNUM(true), 00000000-0000-0000-0000-000000000001)
called ClearIntent("l", TDNUM(true), 00000000-0000-0000-0000-000000000001)
called ClearIntent("m", TDNUM(true), 00000000-0000-0000-0000-000000000001)
called ClearIntent("n", TDNUM(true), 00000000-0000-0000-0000-000000000001)
called ClearIntent("o", TDNUM(true), 00000000-0000-0000-0000-000000000001)
called ClearIntent("p", TDNUM(true), 00000000-0000-0000-0000-000000000001)
called ClearIntent("q", TDNUM(true), 00000000-0000-0000-0000-000000000001)
called ClearIntent("r", TDNUM(true), 00000000-0000-0000-0000-000000000001)
stats: live_bytes:-432 val_bytes:-864 intent_bytes:-279 intent_count:-18 separated_intent_count:-18
rangekey: {g-s}/[4.000000000,0 3.000000000,0]
data: "a"/6.000000000,0 -> /BYTES/a6
data: "b"/6.000000000,0 -> /BYTES/b6
data: "b"/1.000000000,0 -> /BYTES/b1
data: "c"/6.000000000,0 -> /BYTES/c6
data: "c"/1.000000000,0 -> /<empty>
data: "d"/6.000000000,0 -> /<empty>
data: "e"/6.000000000,0 -> /<empty>
data: "e"/1.000000000,0 -> /BYTES/e1
data: "f"/6.000000000,0 -> /<empty>
data: "f"/1.000000000,0 -> /<empty>
data: "g"/6.000000000,0 -> /BYTES/g6
data: "g"/1.000000000,0 -> /BYTES/g1
data: "h"/6.000000000,0 -> /BYTES/h6
data: "h"/1.000000000,0 -> /<empty>
data: "i"/6.000000000,0 -> /BYTES/i6
data: "i"/1.000000000,0 -> /BYTES/i1
data: "j"/6.000000000,0 -> /<empty>
data: "j"/1.000000000,0 -> /<empty>
data: "k"/6.000000000,0 -> /<empty>
data: "l"/6.000000000,0 -> /<empty>
data: "m"/6.000000000,0 -> /BYTES/m6
data: "n"/6.000000000,0 -> /BYTES/n6
data: "n"/5.000000000,0 -> /BYTES/n5
data: "o"/6.000000000,0 -> /BYTES/o6
data: "o"/5.000000000,0 -> /<empty>
data: "p"/6.000000000,0 -> /<empty>
data: "q"/6.000000000,0 -> /<empty>
data: "q"/5.000000000,0 -> /BYTES/q5
data: "r"/6.000000000,0 -> /<empty>
data: "r"/5.000000000,0 -> /<empty>
stats: {
  contains_estimates:0
  last_update_nanos:1000000000000
  intent_age:0
  gc_bytes_age:332427
  live_bytes:189
  live_count:9
  key_bytes:396
  key_count:18
  val_bytes:105
  val_count:30
  intent_bytes:0
  intent_count:0
  separated_intent_count:0
  range_key_count:1
  range_key_bytes:22
  sys_bytes:0
  sys_count:0
  abort_span_bytes:0
}
